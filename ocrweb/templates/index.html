<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RapidOCR Demo</title>
    <link rel=stylesheet type="text/css" href="{{url_for('static', filename='css/main.css')}}">
    <link rel="shortcut icon" href="/static/css/favicon.ico" type="image/x-icon"/>
</head>
<body>
    <h1 align="center">
        <b><i>RapidğŸ—²OCR Demo</i></b>&nbsp;
        <a href="https://github.com/RapidAI/RapidOCR" style="font-size: 14px;">æ¬¢è¿Star</a>&thinsp;
        <a href="https://github.com/RapidAI/RapidOCR/tree/main/ocrweb#readme" style="font-size:14px">äº†è§£Demo</a>
    </h1>
    <div class='area'>
        <span class="btn-gen" onclick="javascript:$('#rapid_ocr').click();">è¯•è¯•ä½ çš„å›¾ç‰‡?</span>
        <input type="file" style="display: none;" name="pic" id="rapid_ocr"/>
        <span class="uplodNote">æ”¯æŒPNGã€JPGã€JPEGã€BMPï¼Œå›¾ç‰‡å¤§å°ä¸è¶…è¿‡3Mã€‚</span>
    </div>
    <br/>
    <div class="area">
        <div class="leftarea" id="detectDiv">
            <span class="span_title">æ–‡ æœ¬ æ£€ æµ‹ ç»“ æœ</span><br/><br/>
            <div class="wrapper" id="wrapper" hidden></div>
            <img id="detect_img" src=""/>
        </div>

        <div class="rightarea" id="recogDiv">
            <span id="rec_res" class="span_title">æ–‡ æœ¬ è¯† åˆ« ç»“ æœ</span>
            <br/><br/>
            <table id="locTable" class="table" cellspacing="0" cellpadding="5"></table>
        </div>
    </div>
    <script src="{{url_for('static', filename='js/jquery-3.0.0.min.js')}}"></script>
    <script type="text/javascript">
        // é¡µé¢åŠ è½½æ—¶ï¼Œæ‰§è¡Œ
        window.onload = function () {
            $('#detect_img').attr("width", "");
            $('#detect_img').attr("height", "");
        }

        $("#rapid_ocr").change(function(){
            let file = document.getElementById("rapid_ocr").files[0];

            // åˆ¤æ–­å›¾åƒæ ¼å¼æ˜¯å¦åŒ¹é…
            let imageName = file.name;
            let index = imageName.lastIndexOf('.');
            let extName = imageName.substr(index + 1);
            let imgArr = ['jpg', 'bmp', 'png', 'jpeg'];
            if (!(imgArr.includes(extName.toLocaleLowerCase()))){
                alert("å›¾åƒæ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼");
                return;
            }

            // åˆ¤æ–­å›¾åƒå¤§å°æ˜¯å¦ç¬¦åˆ
            let imageSize = file.size / 1024 / 1024;
            if (imageSize >= 3) {
                alert("å›¾åƒå¤§å°è¶…è¿‡3Mï¼");
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e){
                var upload_data = {"file": reader.result};
                $.ajax(
                {
                    url:"/ocr",
                    type:"POST",
                    data: JSON.stringify(upload_data),
                    contentType: 'application/json; charset=UTF-8',
                    dataType: 'json',

                    beforeSend:function(){
                        $("#detect_img").attr('src', reader.result);
                        $("#detect_img").attr("width", "95%");
                        $("#detect_img").attr("height", "100%");

                        $("#wrapper").show();
                        $("#locTable").hide();
                        $("#rec_res").html("æ–‡æœ¬è¯†åˆ«ç»“æœ");
                    },

                    success:function (data) {
                        $("#wrapper").hide();
                        if (data){
                            if (data['image']){
                                $("#detect_img").attr('src', 'data:image/jpeg;base64,'+ data['image']);
                                $('#detect_img').show();
                            }

                            if (data["total_elapse"]){
                                document.getElementById("rec_res").textContent = "æ–‡ æœ¬ æ£€ æµ‹ ç»“ æœ(Total:" + String(data["total_elapse"]) + "s)"
                                $("#rec_res").show();
                            }

                            if (data["rec_res"]){
                                var rec_res = JSON.parse(data["rec_res"]);

                                // console.log(data['elapse_part']);
                                if (data['elapse_part']){
                                    var elapse_list = data['elapse_part'].split(',');
                                }else{
                                    var elapse_list = [0, 0, 0];
                                }
                                var data = "";
                                data += "<tr>" +
                                            '<th align="right">Det: ' + elapse_list[0] + 's</th>' +
                                            '<th align="center">Cls: ' + elapse_list[1] + 's</th>' +
                                            '<th align="left">Rec: ' + elapse_list[2] + 's</th>' +
                                        "</tr>"
                                data += "<tr>" +
                                            '<th bgcolor="#C0C0C0">åºå·</th>' +
                                            '<th bgcolor="#C0C0C0">è¯†åˆ«ç»“æœ</th>' +
                                            '<th bgcolor="#C0C0C0">ç½®ä¿¡åº¦</th>' +
                                        "</tr>"
                                for (let i = 0; i < rec_res.length; i++) {
                                    const element = rec_res[i];
                                    let num = element[0];

                                    let rec_result = element[1];

                                    let score = Number(element[2]);
                                    score = score.toFixed(4);

                                    data += "<tr>"
                                    data += "<td>" + num + "</td>";
                                    data += "<td align='left'>" + rec_result + "</td>";
                                    data += "<td>" + score + "</td>";
                                    data += "</tr>"
                                }
                                document.getElementById("locTable").innerHTML = data;
                                $("#locTable").show();
                            }
                        }

                    }
                }
            );
            }
            reader.readAsDataURL(this.files[0])
        });
    </script>
</body>
</html>