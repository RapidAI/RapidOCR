<!-- 
    Provided by BUPT
 -->
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>RapidOCR Demo</title>
    <link rel=stylesheet  href="../static/css/main.css">
    <link rel="shortcut icon" href="/static/css/favicon.ico" type="image/x-icon"/>
</head>
<body>
    <header>
        <div class="head-wrapper">
            <div class="logo">
                <img src="../static/css/favicon.jpg" height="80px" alt="logo">
            </div>
            <div class="title">
                <b><i>RapidğŸ—²OCR Demo</i></b>
            </div>
            <span>ä¸ºä¸–ç•Œå†…å®¹å®‰å…¨è´¡çŒ®åŠ›é‡</span>
            <ul class="link">
                <li>
                    <a href="https://github.com/RapidAI/RapidOCR/tree/main/ocrweb#readme"><b>äº†è§£Demo</b></a>
                </li>
                <li>
                    <a href="https://github.com/RapidAI/RapidOCR"><b>æ¬¢è¿Star</b></a>
                </li>
                
            </ul>
        </div>
    </header>
    <article>
        <div class="introduction" id="introduction">
            <span class="small-title">é¡¹ ç›® ç®€ ä»‹</span>
            <ul class="intro">
                <li>ç›®å‰å·²çŸ¥è¿è¡Œé€Ÿåº¦æœ€å¿«ã€æ”¯æŒæœ€å¹¿ï¼Œå®Œå…¨å¼€æºå…è´¹å¹¶æ”¯æŒç¦»çº¿éƒ¨ç½²çš„å¤šå¹³å°å¤šè¯­è¨€OCR SDK</li>
                <li>ä¸­æ–‡å¹¿å‘Šï¼š æ¬¢è¿åŠ å…¥æˆ‘ä»¬çš„QQç¾¤ä¸‹è½½æ¨¡å‹åŠæµ‹è¯•ç¨‹åºï¼Œqqç¾¤å·ï¼š887298230</li>
                <li>ç¼˜èµ·ï¼šç™¾åº¦paddlepaddleå·¥ç¨‹åŒ–ä¸æ˜¯å¤ªå¥½ï¼Œä¸ºäº†æ–¹ä¾¿å¤§å®¶åœ¨å„ç§ç«¯ä¸Šè¿›è¡Œocræ¨ç†ï¼Œæˆ‘ä»¬å°†å®ƒè½¬æ¢ä¸ºonnxæ ¼å¼ï¼Œä½¿ç”¨Python/C++/Java/Swift/C# å°†å®ƒç§»æ¤åˆ°å„ä¸ªå¹³å°ã€‚</li>
                <li>åç§°æ¥æºï¼š è½»å¿«å¥½çœå¹¶æ™ºèƒ½ã€‚ åŸºäºæ·±åº¦å­¦ä¹ æŠ€æœ¯çš„OCRæŠ€æœ¯ï¼Œä¸»æ‰“äººå·¥æ™ºèƒ½ä¼˜åŠ¿åŠå°æ¨¡å‹ï¼Œä»¥é€Ÿåº¦ä¸ºä½¿å‘½ï¼Œæ•ˆæœä¸ºä¸»å¯¼ã€‚</li>
                <li>åŸºäºç™¾åº¦çš„å¼€æºPaddleOCR æ¨¡å‹åŠè®­ç»ƒï¼Œä»»ä½•äººå¯ä»¥ä½¿ç”¨æœ¬æ¨ç†åº“ï¼Œä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä½¿ç”¨ç™¾åº¦çš„paddlepaddleæ¡†æ¶è¿›è¡Œæ¨¡å‹ä¼˜åŒ–ã€‚</li>
            </ul>
        </div>

        <div class="leftarea" id="detectDiv">
            <span class="small-title">æ–‡ æœ¬ æ£€ æµ‹ ç»“ æœ</span>
            <div class="img-wrapper">
                <!-- åŒå±‚åŒ…è£¹ä½¿wrapperå®Œå…¨è¦†ç›–å›¾ç‰‡ -->
                <div class="container">
                    <div class="wrapper" id="wrapper"  ></div>
                    <div class="img" id="img-table">
                        <img id="detect_img" src=""/>
                    </div>
                </div>   
            </div>
            
            <div class='button-area' >
                <span class="btn-gen" onclick="javascript:$('#rapid_ocr').click();">è¯•è¯•ä½ çš„å›¾ç‰‡?</span>
                <input type="file" style="display: none;" name="pic" id="rapid_ocr"/>
                <span class="uplodNote">å¯æ‹–æ‹½ã€ç²˜è´´ã€ç‚¹å‡»ï¼Œæ”¯æŒPNGã€JPGã€JPEGã€BMPï¼Œå›¾ç‰‡å¤§å°ä¸è¶…è¿‡3Mã€‚</span>
            </div>
        </div>

        <div class="rightarea" id="recogDiv">
            <span id="rec_res" class="small-title">æ–‡ æœ¬ è¯† åˆ« ç»“ æœ</span>
            <div class="div-table">
                <table id="locTable" class="table" cellspacing="0" cellpadding="5"></table>
            </div>
            <div class="button-area">
                <!-- ç•™ä¸‹ä¸¤ä¸ªæŒ‰é’®çš„ä½ç½®ï¼Œåç»­å®Œå–„ç›¸åº”åŠŸèƒ½ -->
                <span class="btn-copy" onclick="copy_table()">å¤åˆ¶</span>
                <span class="btn-table-excel" onclick="table_to_excel()">å¯¼å‡ºExcel</span>
            </div>
        </div>
    </article>
    <script src="{{url_for('static', filename='js/jquery-3.0.0.min.js')}}"></script>
    <script type="text/javascript">
        // é¡µé¢åŠ è½½æ—¶ï¼Œæ‰§è¡Œ
        var targetFile = null;
        window.onload = function () {
            $('#detect_img').attr("width", "");
            $('#detect_img').attr("height", "");
        }

        $("#rapid_ocr").on('change', function (){
            targetFile = document.getElementById("rapid_ocr").files[0];
            requestOCR();
        });

        $("html").on("dragover", function(event) {
            event.preventDefault();
            event.stopPropagation();
            $(this).addClass('dragging');
        });

        $("html").on("dragleave", function(event) {
            event.preventDefault();
            event.stopPropagation();
            $(this).removeClass('dragging');
        });

        $("html").on("drop", function(event) {
            event.preventDefault();
            event.stopPropagation();
            let trans = event.originalEvent.dataTransfer;
            handleData(trans);
        });

        $('html').on('paste', function (e) {
            let trans = e.originalEvent.clipboardData;
            handleData(trans);
        });
        function handleData(trans) {
            if (trans.items) {
                for (let i = 0; i < trans.items.length; i++) {
                    // If dropped items aren't test_files, reject them
                    if (trans.items[i].kind === 'file') {
                        targetFile = trans.items[i].getAsFile();
                        console.log(`handleData: items[${i}].name = ${targetFile.name}`);
                        requestOCR();
                        return;
                    }
                }
            } else {
                // Use DataTransfer interface to access the file(s)
                for (let i = 0; i < trans.files.length; i++) {
                    targetFile = trans.files[i];
                    console.log(`handleData: files[${i}].name = ${targetFile.name}`);
                    requestOCR();
                    return;
                }
            }
        }

        function requestOCR(){
            if (!targetFile){
                return;
            }

            // åˆ¤æ–­å›¾åƒæ ¼å¼æ˜¯å¦åŒ¹é…
            let imageName = targetFile.name;
            let index = imageName.lastIndexOf('.');
            let extName = imageName.substr(index + 1);
            let imgArr = ['jpg', 'bmp', 'png', 'jpeg'];
            if (!(imgArr.includes(extName.toLocaleLowerCase()))){
                alert("å›¾åƒæ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼");
                return;
            }

            // åˆ¤æ–­å›¾åƒå¤§å°æ˜¯å¦ç¬¦åˆ
            let imageSize = targetFile.size / 1024 / 1024;
            if (imageSize >= 3) {
                alert("å›¾åƒå¤§å°è¶…è¿‡3Mï¼");
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e){
                var upload_data = {"file": reader.result};
                $.ajax(
                {
                    url:"/ocr",
                    type:"POST",
                    data: JSON.stringify(upload_data),
                    contentType: 'application/json; charset=UTF-8',
                    dataType: 'json',
                    beforeSend:function(){
                        $("#detect_img").attr('src', reader.result);
                        $("#wrapper").show();
                        $("#locTable").hide();
                        $("#rec_res").html("æ–‡æœ¬è¯†åˆ«ç»“æœ");
                    },

                    success:function (data) {
                        $("#wrapper").hide();
                        if (data){
                            // å¯¹åç¼€åæ˜¯å›¾ç‰‡æ ¼å¼ï¼Œä½†å®é™…ä¸æ˜¯å›¾ç‰‡çš„æ–‡ä»¶ç»™å‡ºæç¤º
                            // Provided by BUPT
                            if(data['message']){
                                alert("æ‚¨ä¸Šä¼ çš„æ–‡ä»¶ä¸æ˜¯å›¾ç‰‡!")
                            }

                            // ç»¼åˆåˆ¤æ–­OCRè¿‡ç¨‹ä¸­æ˜¯å¦å­˜åœ¨å®‰å…¨é—®é¢˜ï¼ˆåŒ…æ‹¬ï¼šjsã€cssã€urlæ³¨å…¥ï¼Œè¿è§„è¯æ±‡æ£€æµ‹ï¼‰
                            // Provided by BUPT
                            if (data["det_str"]){
                                {#var security_check = JSON.parse(data["det_str"]);#}
                                if (data["det_str"] != ""){
                                    alert(data["det_str"]);
                                }
                            }

                            if (data['image']){
                                $("#detect_img").attr('src', 'data:image/jpeg;base64,'+ data['image']);
                                $('#detect_img').show();
                            }

                            if (data["total_elapse"]){
                                document.getElementById("rec_res").textContent = "æ–‡ æœ¬ æ£€ æµ‹ ç»“ æœ(Total:" + String(data["total_elapse"]) + "s)"
                                $("#rec_res").show();
                            }
                            
                            if (data["rec_res"]){
                                var rec_res = JSON.parse(data["rec_res"]);
                                // å®ç°å¯¹éæ³•å›¾ç‰‡çš„å®‰å…¨ä¿æŠ¤
                                // Provided by BUPT
                                var regex = /<([a-z][\s\S]*)>.*<\/([a-z][\s\S]*)>/i;
                                var full_text = "";
                                for(let k = 0; k < rec_res.length; k++){
                                    var temp = rec_res[k];
                                    var words = temp[1];
                                    full_text = full_text + words;
                                }
                                var result = regex.test(full_text);
                                if(result){
                                    alert("ç–‘ä¼¼å­˜åœ¨æ¶æ„ä»£ç ï¼Œæ–‡æœ¬ç»“æœå°†ä¸ä¼šåœ¨è¡¨æ ¼ä¸­æ˜¾ç¤ºï¼");
                                }
                                else{
                                    if (data['elapse_part']){
                                        var elapse_list = data['elapse_part'].split(',');
                                    }else{
                                        var elapse_list = [0, 0, 0];
                                    }
                                    var data = "";
                                    data += "<tr>" +
                                                '<th align="right">Det: ' + elapse_list[0] + 's</th>' +
                                                '<th align="center">Cls: ' + elapse_list[1] + 's</th>' +
                                                '<th align="left">Rec: ' + elapse_list[2] + 's</th>' +
                                            "</tr>"
                                    data += "<tr>" +
                                                '<th bgcolor="#C0C0C0">åºå·</th>' +
                                                '<th bgcolor="#C0C0C0">è¯†åˆ«ç»“æœ</th>' +
                                                '<th bgcolor="#C0C0C0">ç½®ä¿¡åº¦</th>' +
                                            "</tr>"
                                    for (let i = 0; i < rec_res.length; i++) {
                                        const element = rec_res[i];
                                        let num = element[0];

                                        let rec_result = element[1];
                                        let score = Number(element[2]);
                                        score = score.toFixed(4);

                                        data += "<tr>"
                                        data += "<td>" + num + "</td>";
                                        data += "<td align='left'>" + rec_result + "</td>";
                                        data += "<td>" + score + "</td>";
                                        data += "</tr>"
                                    }
                                    document.getElementById("locTable").innerHTML = data;
                                    $("#locTable").show();
                                }
                            }

                        }

                    }
                }
            );
            }
            reader.readAsDataURL(targetFile)
        }
    </script>
    <script>
        function copy_table(){
            alert("Copy the table to Pasteboard!");
        }
        function table_to_excel()
        {
            alert("Change table to Excel!");
        }
        </script>
    <footer>
        <br>
    </footer>
</body>
